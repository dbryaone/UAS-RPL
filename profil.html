<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Profil - PustakaHub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        /* CSS lo tetep sama, gue pertahankan estetikanya */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; margin: 0; }
        .container { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .back-nav { margin-bottom: 25px; }
        .btn-back { text-decoration: none; color: #3498db; font-weight: bold; font-size: 14px; display: inline-flex; align-items: center; transition: 0.3s; }
        .btn-back:hover { color: #2980b9; transform: translateX(-5px); }
        .profile-section { text-align: center; margin-bottom: 35px; position: relative; }
        .profile-pic { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 4px solid #3498db; transition: 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-change-pic { display: block; margin: 12px auto; color: #3498db; text-decoration: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .form-group { margin-bottom: 22px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; background-color: #fafafa; transition: 0.3s; }
        textarea { height: 100px; resize: none; }
        .btn-save { width: 100%; padding: 14px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-save:hover { background: #2980b9; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .identity-badge { background: #e8f4fd; padding: 15px; border-radius: 8px; margin-top: 25px; border-left: 5px solid #3498db; font-size: 13px; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <div class="back-nav">
        <a href="index.html" class="btn-back"><span>&#8592; Kembali ke Beranda</span></a>
    </div>

    <div class="profile-section">
        <img src="https://via.placeholder.com/130" alt="Profil" class="profile-pic" id="foto-preview" onclick="document.getElementById('input-galeri').click();">
        <label for="input-galeri" class="btn-change-pic">Ganti Foto Profil</label>
        <input type="file" id="input-galeri" accept="image/*" style="display: none;">
    </div>

    <form id="form-profil">
        <div class="form-group">
            <label>Username (ID Anggota)</label>
            <input type="text" id="username" placeholder="Masukkan username baru..." required>
        </div>

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="nama_lengkap" placeholder="Tulis nama lengkap Anda di sini...">
        </div>
        
        <div class="form-group">
            <label>Tanggal Lahir</label>
            <input type="date" id="tgl_lahir" value="2006-11-17"> 
        </div>

        <div class="form-group">
            <label>Bio Singkat</label>
            <textarea id="bio" placeholder="Ceritakan sedikit tentang dirimu (hobi, buku favorit, dll)..."></textarea>
        </div>

        <button type="submit" class="btn-save">Simpan Perubahan ke Cloud</button>
    </form>

    <div class="identity-badge">
        <strong>ðŸ’¡ Info Identitas:</strong> Data ini tersinkronisasi dengan database <strong>Supabase</strong>. Pastikan username unik untuk menghindari bentrok data.
    </div>
</div>

<script>
    const inputFile = document.getElementById('input-galeri');
    const fotoPreview = document.getElementById('foto-preview');
    const form = document.getElementById('form-profil');

    // 1. Fungsi muat data pas halaman dibuka (Ambil dari Supabase berdasarkan Username)
    // Untuk demo, kita pakai prompt sederhana dulu buat nanya username lo
    window.onload = async function() {
        const cekUser = localStorage.getItem('last_user'); // Kita inget-inget dikit username terakhir
        if (cekUser) {
            const { data, error } = await supabase
                .from('anggota')
                .select('*')
                .eq('username', cekUser)
                .single();
            
            if (data) {
                document.getElementById('username').value = data.username;
                document.getElementById('nama_lengkap').value = data.nama_anggota;
                document.getElementById('tgl_lahir').value = data.tanggal_lahir || '2006-11-17';
                document.getElementById('bio').value = data.bio;
                if (data.foto_url) fotoPreview.src = data.foto_url;
            }
        }
    };

    // 2. Preview Foto
    inputFile.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => fotoPreview.src = e.target.result;
            reader.readAsDataURL(file);
        }
    });

    // 3. Simpan ke Supabase
    form.onsubmit = async function(e) {
        e.preventDefault();
        
        const usernameVal = document.getElementById('username').value;
        const payload = {
            username: usernameVal,
            nama_anggota: document.getElementById('nama_lengkap').value,
            tanggal_lahir: document.getElementById('tgl_lahir').value,
            bio: document.getElementById('bio').value,
            foto_url: fotoPreview.src // Ini masih base64, nanti bisa di-upgrade ke Supabase Storage
        };

        const { error } = await supabase
            .from('anggota')
            .upsert(payload, { onConflict: 'username' });

        if (error) {
            alert("Aduh, gagal simpan Yang Mulia: " + error.message);
        } else {
            localStorage.setItem('last_user', usernameVal); // Ingetin usernamenya buat nanti
            alert("Mantap Yang Mulia! Data lo udah resmi mendarat di awan Supabase.");
        }
    };
</script>

</body>
</html>